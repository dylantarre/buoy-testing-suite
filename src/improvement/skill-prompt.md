# Buoy Self-Improvement Cycle

You are running an autonomous improvement cycle for Buoy, a design drift detection tool.

## Your Mission

1. Read the current improvement state
2. Pick the next task from the roadmap
3. Run baseline tests against real design system repos
4. Implement the fix in the Buoy codebase
5. Run tests again to measure improvement
6. **ONLY commit if metrics improved** (never regress)
7. Update changelog with exactly what changed and why
8. Bump version number
9. Update state and exit

## Context

- **Buoy repo**: /Users/dylantarre/dev/buoy
- **Testing suite**: /Users/dylantarre/dev/buoy-testing-suite
- **State file**: /Users/dylantarre/dev/buoy-testing-suite/.improvement/state.json
- **Changelog**: /Users/dylantarre/dev/buoy-testing-suite/.improvement/CHANGELOG.md
- **Logs**: /Users/dylantarre/dev/buoy-testing-suite/.improvement/logs/

## Logging Structure

All logs go to `/Users/dylantarre/dev/buoy-testing-suite/.improvement/logs/`:

```
logs/
â”œâ”€â”€ runner-YYYY-MM-DD.log     # Runner activity log
â”œâ”€â”€ cycle-N-task-id.log       # Individual cycle output
â””â”€â”€ metrics-history.json      # Historical metrics for trend analysis
```

## Step-by-Step Process

### Step 1: Load State

Read `.improvement/state.json` to understand:
- What task is current (if any)
- What's next in the queue
- How many cycles have run
- Previous metrics for regression comparison

### Step 2: Select Task

If no current task, pick the highest priority pending task from the state.

### Step 3: Run Baseline Tests

```bash
cd /Users/dylantarre/dev/buoy-testing-suite
./dist/cli.js run batch --top 3
```

Capture the output and record:
- How many components detected?
- How many tokens detected?
- Coverage percentage?

**SAVE THESE NUMBERS** - you'll compare against them later.

### Step 4: Implement the Fix

Based on the task, modify the relevant files in Buoy:
- Scanner improvements: `/Users/dylantarre/dev/buoy/packages/scanners/src/`
- Token detection: `/Users/dylantarre/dev/buoy/packages/core/src/`
- CLI changes: `/Users/dylantarre/dev/buoy/apps/cli/src/`

Follow TDD:
1. Write a test that fails (captures the missing pattern)
2. Implement the fix
3. Verify the test passes

Build after changes:
```bash
cd /Users/dylantarre/dev/buoy
pnpm build
pnpm test
```

### Step 5: Run Tests Again

```bash
cd /Users/dylantarre/dev/buoy-testing-suite
./dist/cli.js run batch --top 3
```

### Step 6: Compare Metrics (CRITICAL)

Compare to baseline:

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Components | X | Y | +/- Z |
| Tokens | X | Y | +/- Z |
| Coverage | X% | Y% | +/- Z% |

**DECISION GATE:**

```
IF after.components >= before.components
   AND after.tokens >= before.tokens
   AND after.coverage >= before.coverage
   AND (after.components > before.components
        OR after.tokens > before.tokens
        OR after.coverage > before.coverage)
THEN proceed to commit
ELSE abort and try different approach
```

In plain English:
- **NEVER regress** any metric
- **MUST improve** at least one metric
- If no improvement, do NOT commit - revise approach

### Step 7: Commit if Improved

Only if metrics improved and tests pass:

```bash
cd /Users/dylantarre/dev/buoy

# Bump patch version
npm version patch --no-git-tag-version

git add -A
git commit -m "feat(scanners): [task-id] - description

Before: X components, Y tokens, Z% coverage
After: X components, Y tokens, Z% coverage
Improvement: +N components, +M tokens

Tested against: chakra-ui, shadcn-ui, mantine

ðŸ¤– Generated by autonomous improvement loop
Cycle: #N"
```

### Step 8: Update Changelog

Append to `.improvement/CHANGELOG.md`:

```markdown
## Cycle N - YYYY-MM-DD HH:MM

### Task: [task-id] - [title]

**Changes:**
- [List of specific code changes]

**Metrics:**
| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Components | X | Y | +Z |
| Tokens | X | Y | +Z |
| Coverage | X% | Y% | +Z% |

**Files Modified:**
- packages/scanners/src/git/react-scanner.ts
- (other files)

**Commit:** [short hash]

---
```

### Step 9: Update State

Update `.improvement/state.json`:
- Mark task completed (or failed)
- Record metrics (before AND after)
- Record commit hash
- Increment cycle count
- Update version number

### Step 10: Exit with Status

Print a summary:
```
IMPROVEMENT CYCLE COMPLETE
==========================
Task: [task-id]
Result: SUCCESS/FAILED/NO_IMPROVEMENT
Before: X components, Y tokens, Z% coverage
After: X components, Y tokens, Z% coverage
Version: 0.1.X â†’ 0.1.Y
Commit: [hash]
Next: [next-task-id]

Logs: .improvement/logs/cycle-N-task-id.log
```

## Important Rules

1. **One task per cycle** - Do one thing well, then exit
2. **Measure everything** - Always capture before/after metrics
3. **NEVER regress** - If any metric goes down, don't commit
4. **Require improvement** - Must improve at least one metric to commit
5. **Document everything** - Changelog must explain what and why
6. **Bump version** - Every successful commit bumps patch version
7. **Leave state clean** - Always update state.json before exiting

## Error Handling

If something fails:
- Log the error to state.json with full details
- Log to `.improvement/logs/cycle-N-task-id.log`
- Increment attempt counter
- If 3 attempts fail, mark task as failed and move on
- Exit with non-zero code

If improvement doesn't work:
- Log what was tried and why it didn't help
- Revert changes: `git checkout .`
- Mark attempt, try different approach next cycle
- DO NOT commit non-improvements

## Regression Prevention Checklist

Before committing, verify ALL of these:

- [ ] `pnpm build` succeeds
- [ ] `pnpm test` passes
- [ ] Components detected >= baseline
- [ ] Tokens detected >= baseline
- [ ] Coverage >= baseline
- [ ] At least one metric improved
- [ ] No new TypeScript errors
- [ ] Changelog updated

If ANY check fails, abort the commit.

## Test Repos for Validation

Use these repos for baseline testing:
1. `chakra-ui/chakra-ui` - Ark UI wrappers, createRecipeContext
2. `shadcn-ui/ui` - CVA pattern, registry structure
3. `mantinedev/mantine` - polymorphicFactory pattern

These are already cloned in `/Users/dylantarre/dev/buoy-testing-suite/repos/`

## Metrics History

Append each cycle's metrics to `.improvement/logs/metrics-history.json`:

```json
{
  "cycles": [
    {
      "cycle": 1,
      "timestamp": "2025-12-30T...",
      "task": "monorepo-detection",
      "before": { "components": 45, "tokens": 120, "coverage": 67 },
      "after": { "components": 52, "tokens": 120, "coverage": 71 },
      "committed": true,
      "version": "0.1.1"
    }
  ]
}
```

This enables trend analysis over time.
